<% layout("/layouts/boilerplate") -%>

<body>

  <!-- TAX SWItCH -->
  <div class="container mt-5">
    <div class="tax-toggle d-flex justify-content-between align-items-center shadow-sm">
      <label class="form-check-label fw-semibold" for="switchCheckDefault">
        💰 Display total after taxes
      </label>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault">
      </div>
    </div>
  </div>

  <!-- ALL LISTING  -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 mt-3">

    <% if (allListings.length === 0) { %>
      <p class="text-center">No listings found for "<%= searchQuery %>"</p>
    <% } else { %>

      <% for (let listing of allListings) { %>
        <div class="col mb-3">
          <div class="card listing-card position-relative shadow-sm reveal">

            <!-- Listing Image -->
            <a href="/listings/<%= listing._id %>" class="listing-link">
              <img src="<%= listing.image.url %>" class="card-img-top" alt="listing_image" style="height: 20rem; object-fit: cover;">
            </a>

            <!-- ❤️ Favorite Button -->
           <form action="/users/favorites/<%= listing._id %>" method="POST" class="favorite-form">
            <% if (currUser) { %>
              <button type="submit" class="favorite-btn listing-link">
                <% if (currUser.favorites && currUser.favorites.some(fav => fav.toString() === listing._id.toString())) { %>
                  <!-- Solid Red Heart -->
                  <i class="fa-solid fa-heart text-danger"></i>
                <% } else { %>
                  <!-- Outline Heart -->
                  <i class="fa-regular fa-heart"></i>
                <% } %>
              </button>
            <% } else { %>
              <!-- Agar user login nahi hai -->
              <a href="/login" class="favorite-btn listing-link">
                <i class="fa-regular fa-heart"></i>
              </a>
            <% } %>
          </form>


            <!-- Card Content -->
            <div class="card-body">
              <p class="card-text">
                <b><%= listing.title %></b> <br>
                &#8377 <%= listing.price.toLocaleString("en-IN") %> / night
                <i class="tax-info">&nbsp; +18% GST</i>
              </p>
            </div>
          </div>
        </div>
      <% } %>
    <% } %>

  </div>
</body>

<script>
  // GST Toggle
  let taxSwitch = document.getElementById("switchCheckDefault");

  taxSwitch.addEventListener("change", () => {
    let taxInfo = document.getElementsByClassName("tax-info");
    for (let info of taxInfo) {
      info.style.display = taxSwitch.checked ? "inline" : "none";
    }
  });

  // ❤️ Favorite Toggle
  document.querySelectorAll(".favorite-form").forEach(form => {
  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    const button = this.querySelector("button");
    const icon = button.querySelector("i");

    // 👉 Frontend instant toggle
    icon.classList.toggle("fa-regular");
    icon.classList.toggle("fa-solid");
    icon.classList.toggle("text-danger");

    try {
      const res = await fetch(this.action, {
        method: this.method,
        headers: { "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/json"
      },

       body: JSON.stringify({}) // dummy body
      });
      
    } catch (err) {
      console.error("Error toggling favorite:", err);
    }
  });
});

</script>
